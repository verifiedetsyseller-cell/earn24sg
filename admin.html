<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - EARN24 SG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0D1117;
            --card-bg-color: #161B22;
            --text-color: #E6EDF3;
            --text-muted-color: #8B949E;
            --input-bg-color: #0D1117;
            --input-border-color: #30363D;
            --accent-color-primary: #2ECC71;
            --danger-color: #991B1B;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
        }
        .text-accent { color: var(--accent-color-primary); }
        .input-field {
            background-color: var(--input-bg-color);
            border: 1px solid var(--input-border-color);
            border-radius: 6px;
        }
        .btn {
            transition: all 0.3s ease;
            padding: 0.5rem 1.5rem;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 6px;
        }
        .btn-primary {
            background-color: var(--accent-color-primary);
            color: #FFFFFF;
        }
        .btn-primary:hover {
            background-color: #27ae60;
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: #FFFFFF;
        }
        .btn-danger:hover {
            background-color: #7f1d1d;
        }
    </style>
</head>
<body>

    <!-- Admin Login View -->
    <div id="admin-login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-8 rounded-lg" style="background-color: var(--card-bg-color);">
            <div>
                <h2 class="mt-6 text-center text-4xl text-accent">Admin Panel</h2>
            </div>
            <form id="admin-login-form" class="mt-8 space-y-6">
                <div id="admin-login-message" class="hidden p-3 text-center text-white rounded-lg"></div>
                <div class="rounded-md shadow-sm space-y-4">
                    <input id="admin-email" name="email" type="email" required class="input-field w-full px-3 py-3 text-white" placeholder="Admin Email">
                    <input id="admin-password" name="password" type="password" required class="input-field w-full px-3 py-3 text-white" placeholder="Password">
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-3 px-4 text-sm font-medium btn btn-primary">
                        Authenticate
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard View (Hidden by default) -->
    <div id="admin-dashboard-view" class="hidden">
        <header class="py-4 shadow-md" style="background-color: var(--card-bg-color);">
            <div class="container mx-auto flex justify-between items-center px-6">
                <h1 class="text-3xl">Admin <span class="text-accent">Dashboard</span></h1>
                <button id="admin-logout-button" class="btn btn-danger text-sm">Logout</button>
            </div>
        </header>

        <main class="container mx-auto p-6">
            <!-- Stats -->
            <section id="stats" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="p-6 rounded-lg" style="background-color: var(--card-bg-color);">
                    <h3 class="text-2xl text-accent">Total Users</h3>
                    <p id="stats-total-users" class="text-4xl font-bold">0</p>
                </div>
                <div class="p-6 rounded-lg" style="background-color: var(--card-bg-color);">
                    <h3 class="text-2xl text-accent">Total Opportunities</h3>
                    <p id="stats-total-opportunities" class="text-4xl font-bold">0</p>
                </div>
            </section>

            <!-- User Management -->
            <section id="user-management" class="mb-8">
                <h2 class="text-4xl mb-4 text-accent">User Management</h2>
                <div class="overflow-x-auto rounded-lg" style="background-color: var(--card-bg-color);">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b" style="border-color: var(--input-border-color);">
                                <th class="p-4">Username</th>
                                <th class="p-4">Email</th>
                                <th class="p-4">Points</th>
                                <th class="p-4">USDT Balance</th>
                                <th class="p-4">Joined</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- User data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Opportunity Management -->
            <section id="opportunity-management">
                <h2 class="text-4xl mb-4 text-accent">Opportunity Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Add Opportunity Form -->
                    <div class="p-6 rounded-lg md:col-span-1" style="background-color: var(--card-bg-color);">
                        <h3 class="text-2xl mb-4">Add New Opportunity</h3>
                        <form id="add-opportunity-form" class="space-y-4">
                             <div id="admin-task-message" class="hidden p-3 text-center text-white rounded-lg"></div>
                            <input type="text" name="title" placeholder="Title" required class="input-field w-full p-2">
                            <textarea name="description" placeholder="Description" required class="input-field w-full p-2"></textarea>
                            <input type="number" name="reward" placeholder="Points Reward" required class="input-field w-full p-2">
                            <button type="submit" class="w-full py-2 px-4 btn btn-primary">Add Opportunity</button>
                        </form>
                    </div>
                    <!-- List of Opportunities -->
                    <div class="md:col-span-2 p-6 rounded-lg" style="background-color: var(--card-bg-color);">
                         <h3 class="text-2xl mb-4">Existing Opportunities</h3>
                         <div id="opportunities-list" class="space-y-4">
                            <!-- Opportunities will be listed here -->
                         </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // --- CONFIG ---
        const backendUrl = 'https://earn24sg.onrender.com';

        // --- DOM ELEMENTS ---
        const loginView = document.getElementById('admin-login-view');
        const dashboardView = document.getElementById('admin-dashboard-view');
        const loginForm = document.getElementById('admin-login-form');
        const addOpportunityForm = document.getElementById('add-opportunity-form');

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', initializeAdminPanel);
        loginForm.addEventListener('submit', handleAdminLogin);
        addOpportunityForm.addEventListener('submit', handleAddOpportunity);
        document.getElementById('admin-logout-button').addEventListener('click', handleAdminLogout);

        // --- INITIALIZATION ---
        function initializeAdminPanel() {
            const token = localStorage.getItem('adminAuthToken');
            if (token) {
                showDashboard();
            } else {
                showLogin();
            }
        }

        // --- UI & STATE MANAGEMENT ---
        function showDashboard() {
            loginView.style.display = 'none';
            dashboardView.style.display = 'block';
            fetchAllAdminData();
        }

        function showLogin() {
            loginView.style.display = 'flex';
            dashboardView.style.display = 'none';
        }
        
        function handleAdminLogout() {
            localStorage.removeItem('adminAuthToken');
            showLogin();
        }

        async function fetchAllAdminData() {
            try {
                // Fetch stats, users, and opportunities concurrently
                const [stats, users, opportunities] = await Promise.all([
                    adminApiCall('/api/admin/stats', 'GET'),
                    adminApiCall('/api/admin/users', 'GET'),
                    adminApiCall('/api/opportunities', 'GET') // This is a public route, but we fetch it again here for consistency
                ]);

                // Populate stats
                document.getElementById('stats-total-users').textContent = stats.totalUsers;
                document.getElementById('stats-total-opportunities').textContent = stats.totalOpportunities;

                // Populate users table
                const usersTableBody = document.getElementById('users-table-body');
                usersTableBody.innerHTML = users.map(user => `
                    <tr class="border-b" style="border-color: var(--input-border-color);">
                        <td class="p-4">${user.username}</td>
                        <td class="p-4">${user.email}</td>
                        <td class="p-4">${user.points}</td>
                        <td class="p-4">${user.balanceUSDT.toFixed(2)}</td>
                        <td class="p-4">${new Date(user.registrationDate).toLocaleDateString()}</td>
                    </tr>
                `).join('');
                
                // Populate opportunities list
                renderOpportunities(opportunities.opportunities);

            } catch (error) {
                showMessage('admin-login-message', 'Session expired. Please log in again.', 'error');
                handleAdminLogout();
            }
        }
        
        function renderOpportunities(opportunities) {
            const opportunitiesList = document.getElementById('opportunities-list');
            opportunitiesList.innerHTML = opportunities.map(opp => `
                <div class="flex justify-between items-center p-3 rounded" style="background-color: var(--bg-color);">
                    <div>
                        <p class="font-bold">${opp.title}</p>
                        <p class="text-sm" style="color: var(--text-muted-color);">${opp.reward} Points</p>
                    </div>
                    <button class="btn btn-danger px-3 py-1 text-xs" onclick="handleDeleteOpportunity('${opp._id}')">Delete</button>
                </div>
            `).join('');
        }

        // --- API HANDLERS ---
        async function handleAdminLogin(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            try {
                const response = await adminApiCall('/api/auth/admin-login', 'POST', data);
                localStorage.setItem('adminAuthToken', response.token);
                showDashboard();
            } catch (error) {
                showMessage('admin-login-message', error.message, 'error');
            }
        }
        
        async function handleAddOpportunity(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            data.reward = Number(data.reward); // Ensure reward is a number
            try {
                const response = await adminApiCall('/api/admin/opportunities', 'POST', data);
                 showMessage('admin-task-message', response.message, 'success');
                e.target.reset();
                // Refresh data
                const updatedOpportunities = await adminApiCall('/api/opportunities', 'GET');
                renderOpportunities(updatedOpportunities.opportunities);
                document.getElementById('stats-total-opportunities').textContent = updatedOpportunities.opportunities.length;
            } catch (error) {
                 showMessage('admin-task-message', error.message, 'error');
            }
        }
        
        async function handleDeleteOpportunity(id) {
            if (!confirm('Are you sure you want to delete this opportunity?')) return;
             try {
                await adminApiCall(`/api/admin/opportunities/${id}`, 'DELETE');
                // Refresh data after deleting
                fetchAllAdminData();
            } catch (error) {
                alert('Failed to delete opportunity.');
            }
        }

        // --- GENERIC ADMIN API CALL FUNCTION ---
        async function adminApiCall(endpoint, method, body) {
            const options = { method, headers: { 'Content-Type': 'application/json' }};
            const token = localStorage.getItem('adminAuthToken');
            
            if (token) {
                 options.headers['Authorization'] = `Bearer ${token}`;
            }
            if (body) {
                options.body = JSON.stringify(body);
            }
            const response = await fetch(backendUrl + endpoint, options);
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'An API error occurred.');
            }
            return data;
        }
        
        function showMessage(boxId, message, type) {
            const box = document.getElementById(boxId);
            box.textContent = message;
            box.style.display = 'block';
            box.style.backgroundColor = type === 'success' ? '#2ECC71' : '#E74C3C';
            setTimeout(() => { box.style.display = 'none'; }, 3000);
        }

    </script>
</body>
</html>

